ARG PYTHON_VERSION=3.9
ARG PYTORCH_VERSION=1.12.0
ARG ROCM_WHL_VERSION=5.1.1

FROM pytorch_lightning:base-rocm-py${PYTHON_VERSION}-torch${PYTORCH_VERSION}-rocm${ROCM_WHL_VERSION}

ARG LIGHTNING_VERSION=""

COPY ./ /home/lightning/

# install dependencies
RUN \
    cd /home && \
    pip install click deepdiff fastapi lightning-cloud Jinja2 starsessions jsonargparse jsonargparse[signatures] && \
    pip uninstall fsspec -y && \
    pip install fsspec==2022.1.0 && \
    python -m pip install urllib3 && \
    pip install protobuf==3.9.2 && \
    mv lightning/_notebooks notebooks && \
    mv lightning/examples . && \
    # replace by specific version if asked
    if [ ! -z "$LIGHTNING_VERSION" ] ; then \
        rm -rf lightning ; \
        wget https://github.com/Lightning-AI/lightning/archive/${LIGHTNING_VERSION}.zip --progress=bar:force:noscroll ; \
        unzip ${LIGHTNING_VERSION}.zip ; \
        mv lightning-*/ lightning ; \
        rm *.zip ; \
    fi && \
    # otherwise there is collision with folder name ans pkg name on Pypi
    cd lightning && \
    python setup.py install && \
    cd .. && \
    rm -rf lightning

RUN python --version && \
    pip --version && \
    pip list && \
    python -c "import pytorch_lightning as pl; print(pl.__version__)"
