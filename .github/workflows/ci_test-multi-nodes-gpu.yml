name: Multi Nodes GPU tests

# Workflow Steps:
#  1. Set IMAGETAG
#  3. Edit multi-node-test.yaml template to refer to IMAGETAG
#  4. Connect to AWS
#  5. Install EKSClient
 # 6. Clone Elastic repo
#  7. Create node group
#  8. Apply elastic kukeclt cmd
#  9. Launch multi-node-test.yaml
#      - Create a tests/backends/test_multi_nodes.py file
#  10. Use kukeclt to get logs
#  11. Print logs
#  12. Upload coverage.

#on:
#  pull_request:
#    branches: [master, "release/1.0.x"]  # include release branches like release/1.0.x
#    types: [closed]

on: push

env:
  AWS_ACCOUNT: ${{ secrets.AWS_ACCOUNT }}
  IMAGE: ${{ secrets.AWS_ACCOUNT }}.dkr.ecr.us-east-2.amazonaws.com/multi-nodes-gpu-testing
  AWS_REGION: us-east-2
  AWS_CLUSTER: multi-nodes-gpu-testing
  NODE_TYPE: p3.8xlarge
  NODES: 2

jobs:
  setup-build-test-publish:
    name: multi-nodes-gpu-testing
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        python-version: [3.7]
    # Timeout: https://stackoverflow.com/a/59076067/4521646
    timeout-minutes: 50

    # runs only when merged happened.
    #if: github.event.pull_request.merged == true
    steps:

    - name: Set IMAGETAG
      run: echo "IMAGETAG=${{ github.event.pull_request.head.sha }}${{ matrix.python-version }}" >> $GITHUB_ENV

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCES_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY_ID }}
        aws-region: us-east-2

    - name: Configure Docker
      run: |-
        echo "$IMAGE:$IMAGETAG"
        docker build -t "$IMAGE:$IMAGETAG" -f ./dockers/multi-gpu-tests/Dockerfile --build-arg "PYTHON_VERSION=${{ matrix.python-version }}" .
        aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT.dkr.ecr.$AWS_REGION.amazonaws.com
        docker push $IMAGE
      shell: bash    